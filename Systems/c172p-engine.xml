<?xml version="1.0"?>

<!--

  c172p damage effects for JSBSim.

    Copyright (c) 2015 Gilberto Agostinho

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

-->

<system name="engine">

    <channel name="oil">

        <fcs_function name="consumed-oil-weight">
            <function>
                <product>
                    <property>/engines/active-engine/oil-lacking</property>
                    <value>1.7686</value>
                    <value>-1</value>
                </product>
            </function>
            <output>/fdm/jsbsim/inertia/pointmass-weight-lbs[16]</output>
        </fcs_function>

    </channel>

    <channel name="carburetor">

        <fcs_function name="Carb heat on causes RPM drop on 160 HP engine">
            <function>
                <ifthen>
                    <property>/controls/anti-ice/engine[0]/carb-heat</property>
                    <value>0.475</value>
                    <value>0.15185</value>
                </ifthen>
            </function>
            <output>/fdm/jsbsim/propulsion/engine[0]/air-intake-impedance-factor</output>
        </fcs_function>

        <fcs_function name="Carb heat on causes RPM drop on 180 HP engine">
            <function>
                <ifthen>
                    <property>/controls/anti-ice/engine[1]/carb-heat</property>
                    <value>0.475</value>
                    <value>0.15185</value>
                </ifthen>
            </function>
            <output>/fdm/jsbsim/propulsion/engine[1]/air-intake-impedance-factor</output>
        </fcs_function>

    </channel>

    <channel name="damage">
        <fcs_function name="/damage/rpm-over-redline">
            <function>
                <sum>
                    <property>/engines/active-engine/rpm</property>
                    <value>-2750</value>
                </sum>
            </function>
            <clipto>
                <min>0</min>
                <max>10000</max>
            </clipto>
        </fcs_function>

        <fcs_function name="/damage/damage-level">
              <function>
                <ifthen>
                    <eq>
                        <p>/engines/active-engine/damage_allowed</p>
                        <v>1</v>
                    </eq>
                    <sum>
                        <property>/damage/damage-level</property>
                        <product>
                           <table>
                                <independentVar lookup="row">/damage/rpm-over-redline</independentVar>
                                <tableData>
                                    0    0
                                  100    1
                                  200    4
                                  300    9
                                  400   16
                                  500   25
                                  600   36
                                  700   49
                                  800   64
                                  900   81
                                 1000  100
                                 1100  121
                                 1200  144
                                 1300  169
                                 1400  196
                                 1500  225
                                 9999  300
                                </tableData>
                            </table>
                            <property>simulation/channel-dt</property>
                        </product>
                    </sum>
                    <v>0</v> <!-- this is the value if damage is disabled -->
                </ifthen>
            </function>
        </fcs_function>

        <fcs_function>
            <function> <!-- derived from a graphical calculator: 0.01x pow 2 + 2.15x + 0.625 multiplied by 2.4 -->
                <product>
                    <sum>
                        <product>
                            <v>0.00008</v>
                            <pow>
                                <property>/damage/damage-level</property>
                                <v>2</v>
                            </pow>
                        </product>
                        <v>0.625</v>
                    </sum>
                    <v>2.4</v>
                </product>
            </function>
            <clipto>
                <min>0.001</min>
                <max>10000</max>
            </clipto>
            <output>/damage/friction-hp</output>
        </fcs_function>

        <switch name="/damage/engine-0-friction-hp">
            <default-value>1.5</default-value>
            <test  logic="AND" value="/damage/friction-hp">
                /controls/engines/active-engine eq 0
            </test>
            <output>/fdm/jsbsim/propulsion/engine[0]/friction-hp</output>
        </switch>

        <switch name="/damage/engine-1-friction-hp">
            <default-value>1.5</default-value>
            <test  logic="AND" value="/damage/friction-hp">
                /controls/engines/active-engine eq 1
            </test>
            <output>/fdm/jsbsim/propulsion/engine[1]/friction-hp</output>
        </switch>
    </channel>
</system>
